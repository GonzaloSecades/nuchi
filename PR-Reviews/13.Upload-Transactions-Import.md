# PR Overview: CSV Transaction Import Flow with Account Assignment

## Summary

This PR adds an end-to-end CSV transaction import flow in the transactions dashboard: users can upload a CSV file, map columns to required transaction fields, preview imported rows, select a destination account, and submit a bulk transaction creation request; it also adds the UI primitives and dependency support needed for this workflow.

**Key Statistics** bullets:

- Files changed: 13 files (+687/ -6)
- Commits: 5 (`copilot fixes;`, `feat(transactions): refactor ImportCard data transformation logic; enhance TransactionsPage with account selection dialog and import functionality`, `feat(transactions): implement data transformation in ImportCard and update button functionality; fix style issue in TableHeadSelect`, `feat(transactions): enhance ImportCard with progress indicator and update button states; modify TableHeadSelect options and styles`, `feat(transactions): add import functionality with ImportCard and ImportTable components, integrate CSV upload support`)
- Backend: None (no backend service, route, or auth-layer file changes in this PR)
- Frontend: Next.js/React client flow changes in `app/(dashboard)/transactions/*`, plus new reusable select UI primitives and account-selection hook state flow
- Database: None (no schema or migration files changed)

---

## Key Changes by Area

### 1. Frontend - Data/State (Next.js, React hooks, mutation hooks)

**Files:**

- `app/(dashboard)/transactions/page.tsx` - adds import/list variant state, upload result state, submit/cancel handlers, and bulk import submission flow
- `app/(dashboard)/transactions/import-card.tsx` - adds CSV header mapping state, progress gating, row transformation, and submit callback invocation
- `app/(dashboard)/transactions/upload-button.tsx` - adds CSV upload entry-point using `react-papaparse`

**Changes:**

- Adds local view-state enum (`LIST`/`IMPORT`) in transactions page to switch between table view and import workflow.
- Stores parsed upload results in page state and passes parsed row data into import UI.
- Adds import submit handler that:
  - requests an account via `useSelectAccount()`
  - enriches each row with `accountId`
  - executes `useBulkCreateTransactions().mutate(...)`
  - emits success/error toast feedback
- In `ImportCard`, tracks selected CSV-to-field mappings per column (`column_n` keys), de-duplicates mapping choices, and requires `amount`, `date`, and `payee` mappings before continuing.
- Transforms CSV rows before submit by:
  - selecting only mapped columns
  - converting `amount` to milliunits via `convertAmountToMiliunits(...)`
  - parsing/formating dates from `yyyy-MM-dd HH:mm:ss` to `yyyy-MM-dd`
- Adds CSV upload button that invokes `onUploadAccepted` from `react-papaparse`.

**Rationale:**

- Keeps import logic fully client-side for mapping/preview UX before hitting existing bulk-transaction creation APIs.
- Reuses existing mutation hooks rather than introducing new API surface, reducing backend scope for this feature.

### 2. Frontend - UI Components (Shadcn/Radix UI, table rendering)

**Files:**

- `app/(dashboard)/transactions/import-table.tsx` - adds import preview table with selectable header mapping controls
- `app/(dashboard)/transactions/table-head-select.tsx` - adds per-column field picker with option disabling for uniqueness
- `app/(dashboard)/transactions/page.tsx` - updates transactions header actions to include Import and Add New buttons
- `components/ui/select.tsx` - adds reusable Radix-based select UI primitive set
- `features/transactions/components/transaction-form.tsx` - updates submit button label text

**Changes:**

- Adds `ImportTable` to preview parsed CSV rows under mapped headers.
- Adds `TableHeadSelect` with `Skip` option and disabled already-mapped choices to prevent duplicate assignment.
- Adds responsive action layout in transactions header for import and manual-create entry points.
- Introduces a shared `components/ui/select.tsx` primitive suite for select content/trigger/item rendering.
- Changes transaction form create-mode submit label from `Create Transaction` to `Edit Transaction`.

**Rationale:**

- Provides a guided mapping/preview interface to lower import errors before persistence.
- Standardizes select behavior and styling via shared UI primitives.

### 3. State Management (Custom hooks, promise-based dialog flow)

**Files:**

- `features/accounts/hooks/use-select-account.tsx` - new hook that exposes a dialog component and async `confirm()` API
- `components/select.tsx` - adjusts controlled-value behavior to support undefined pass-through for deferred selection states

**Changes:**

- Adds `useSelectAccount()` returning `[AccountDialog, confirm]`.
- `confirm()` opens dialog and resolves a promise with selected `accountId` or `undefined` on cancel/close.
- Dialog supports account creation inline via existing `useCreateAccount`.
- Button state (`Confirm`) is disabled until a selection exists.
- `components/select.tsx` now avoids passing `value` when formatted value is `undefined`, preventing incorrect controlled-state behavior.

**Rationale:**

- Encapsulates modal selection flow behind an async hook API so callers can await account selection in transactional workflows.
- Fixes select controlled/uncontrolled edge behavior needed by the new dialog flow.

### 4. Developer Experience & Configuration (Dependency and repo hygiene)

**Files:**

- `package.json` - adds `react-papaparse`
- `bun.lock` - lockfile updates for new parser dependency chain
- `public/mockTransactions.csv` - adds sample CSV file for local testing
- `.gitignore` - ignores generated `tech_debt_SuggestionsPR08.md`

**Changes:**

- Adds `react-papaparse@4.4.0` dependency and corresponding lockfile entries (`react-papaparse`, `papaparse`, `@types/papaparse`).
- Adds a mock CSV dataset with realistic transaction rows and timestamp format matching import parser expectations.
- Updates gitignore to avoid committing generated PR08 tech debt note.

**Rationale:**

- Enables client CSV ingestion without custom parser implementation.
- Speeds manual QA and feature demos with bundled sample data.

---

## Rationale

### Why This Architecture?

1. Client-first import workflow
   - Mapping and normalization happen before mutation submission, giving users immediate control and validation feedback.
2. Reuse of existing mutation/query hooks
   - The PR routes import writes through `useBulkCreateTransactions`, minimizing API and backend change footprint.
3. Async account-selection abstraction
   - `useSelectAccount` encapsulates modal lifecycle and result handling, avoiding prop drilling and callback complexity in page code.
4. Shared select primitives
   - Introducing `components/ui/select.tsx` centralizes select behavior for both import mapping and future UI reuse.

### Business Value

- Enables bulk transaction ingestion from CSV, reducing manual entry effort.
- Improves onboarding/migration for users moving transaction history from external exports.
- Adds a clearer workflow boundary between data preparation and persistence (mapping -> preview -> account assignment -> import).

---

## Risks & Rollout Considerations

### High-Impact Risks

1. Invalid CSV date format can silently produce bad import payloads
   - Issue: Import parsing expects `yyyy-MM-dd HH:mm:ss`; mismatched source formats may create invalid dates during transform.
   - Mitigation: Add explicit row-level date parse validation and block submit with actionable error messages.
   - Rollback: Disable/hide Import action and revert to previous transactions page state (remove upload/import components).

2. Large CSV uploads can trigger heavy client-side processing and oversized mutation payloads
   - Issue: Full row mapping/formatting happens in-memory and current flow submits all rows in one mutation call.
   - Mitigation: Add upload row limits, chunked submission, and progress/error reporting per batch.
   - Rollback: Revert import entry points and dependency additions while preserving existing transaction list/create flows.

### Medium-Impact Risks

1. Required-field mapping is minimal and may allow semantically incomplete rows
   - Issue: Only `amount`, `date`, and `payee` are enforced by mapping progress; category/account mapping is deferred.
   - Mitigation: Add pre-submit schema checks and row-level warnings for optional-but-recommended fields.
   - Rollback: Keep import behind a feature gate until validations are strengthened.

2. Transaction form create-mode label regression
   - Issue: `features/transactions/components/transaction-form.tsx` now shows `Edit Transaction` in create mode.
   - Mitigation: Restore original create label in a follow-up patch.
   - Rollback: Revert this single-line UI text change independently.

### Low-Impact Risks

1. New shared select primitive styling variance
   - Issue: Added `components/ui/select.tsx` may diverge visually from existing controls in some contexts.
   - Mitigation: Add visual regression checks and unify style tokens where needed.
   - Rollback: Limit select usage to import flow until broader UI alignment is verified.

### Deployment Considerations

**Pre-Deployment:**

- [ ] Install updated dependencies (`react-papaparse`) via lockfile-sync install.
- [ ] Verify import flow build passes in production mode.
- [ ] Validate account-selection dialog fetch/create paths against production account data.

**Post-Deployment Monitoring:**

- [ ] Track client-side import error toasts and failed bulk-create mutation rates.
- [ ] Monitor transaction creation latency/error spikes during import-heavy usage.
- [ ] Watch for parsing-related support tickets tied to CSV format mismatches.

**Rollback Plan:**

- Revert PR commit range introducing import flow files and dependency updates.
- Redeploy prior build artifact.
- Confirm transactions list/manual create/delete flows remain healthy after rollback.

---

## Technical Debt Assessment

### Introduced Technical Debt

1. Limited CSV schema validation
- Issue: Transform logic parses and maps rows but does not provide comprehensive validation/error surfacing per row.
- Impact: Bad rows can pass deeper into mutation flow, increasing failure ambiguity.
- Recommendation: Add a typed row-validation stage with structured error reporting before `onSubmit`.
- Effort: M

2. Potentially unbounded import payload size
- Issue: All mapped rows are submitted in one bulk mutation.
- Impact: Higher memory/network pressure and harder partial-failure recovery.
- Recommendation: Add chunking with configurable batch size and retry strategy.
- Effort: M

3. Minor UX text inconsistency in transaction form
- Issue: Create action label now reads `Edit Transaction`.
- Impact: User confusion on manual transaction creation flow.
- Recommendation: Correct label and add a UI copy assertion test.
- Effort: S

### Mitigated Technical Debt

- Replaces ad-hoc account selection handling with a reusable promise-based hook (`useSelectAccount`).
- Improves shared select controllability by handling undefined value flow in `components/select.tsx`.
- Adds reusable select UI primitives in `components/ui/select.tsx` for consistency across features.

### Recommended Next Steps

**Immediate (This Sprint):**

- Fix create-mode submit label regression in transaction form.
- Add explicit parser validation messaging for unsupported CSV date formats.
- Add basic guardrails for maximum rows per import.

**Short-term (Next Sprint):**

- Introduce chunked bulk-create submission with progress and partial-failure reporting.
- Add import-specific client tests for mapping logic and required-field gating.

**Medium-term (Within Quarter):**

- Support configurable CSV templates (column aliases and multiple date formats).
- Add import audit metadata (source file name, imported-at timestamp) if product scope requires traceability.

**Long-term (Future Quarters):**

- Add asynchronous/background import jobs for very large files with resumable status tracking.
- Expand import pipeline with deduplication heuristics against existing transactions.

---

## Testing Recommendations

### Manual Testing Checklist

- [ ] Upload a valid CSV and map `amount`, `date`, `payee`; verify Continue enables only when all are mapped.
- [ ] Confirm duplicate mapping options are disabled across columns.
- [ ] Import mapped rows after selecting an account; verify success toast and list refresh.
- [ ] Cancel account dialog and verify import is aborted with no mutations.
- [ ] Upload malformed date-format CSV and observe current failure behavior.
- [ ] Verify transaction form create-mode button label behavior.

### Automated Testing Needs

- [ ] Unit tests for `ImportCard` transformation (`amount` milliunit conversion and date parsing/formatting).
- [ ] Component tests for `TableHeadSelect` uniqueness and required-field gating behavior.
- [ ] Hook test for `useSelectAccount` promise resolve/cancel paths.
- [ ] Integration test for transactions page variant switching (list <-> import) and submit flow.

---

## Dependencies & Prerequisites

### Required Environment Variables

- None introduced by this PR.

### External Service Dependencies

- `react-papaparse`/`papaparse` - client-side CSV parsing and upload handling in import flow.

### Breaking Changes

- None identified in changed API/database contracts.

---

## Performance Considerations

### Frontend

- CSV parsing, mapping, and transformation are performed on the client and scale linearly with row count.
- Import preview renders all rows in a table without virtualization; very large files may impact responsiveness.

### API

- Bulk transaction creation is invoked with a single payload from imported rows; request size may become a bottleneck for large files.

---

## Security Considerations

- Authz/Authn: No authentication or authorization logic changes are introduced in this PR.
- Validation: Import mapping enforces required field presence but lacks strict row-level schema validation before mutation.
- Sensitive data handling: CSV content is processed client-side and sent through existing bulk-create transaction flow; no new secret-handling paths are introduced.
- Gap: Invalid/unexpected CSV content handling is limited; stronger input validation and sanitization should be added before production scale rollout.

---

## Conclusion

This PR delivers a functional CSV import workflow integrated into transactions with account assignment and bulk creation, while keeping backend/database scope unchanged. Readiness is high for controlled rollout, but validation hardening and large-file guardrails should be prioritized.

- Deployment Status: ⚠️ Needs Follow-up (date-format validation and bulk-size safeguards are not yet implemented)
- Generated: February 9, 2026
- Branch: 08.UploadTransactions (from `pr-13` head ref)
- Base: master (from `pr-13-merge` base parent)
- Files Changed: 13 files (+687/ -6)
